apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  context: |
    argocdUrl: http://localhost:8080 
  
  service.teams: |
    recipientUrls:
      opsgenie-test: $channel-teams-url # Correctly referencing the secret

  # --- Triggers (Each trigger gets its own top-level key) ---

  # Trigger for successful sync
  trigger.on-sync-succeeded: |
    - description: Application sync succeeded
      send:
        - sync-succeeded
      when: app.status.sync.status == 'Synced' and app.status.health.status == 'Healthy'

  trigger.on-sync-failed: |
    - description: Application sync failed
      send:
        - sync-failed
      when: app.status.sync.status == 'OutOfSync' or app.status.health.status == 'Degraded' or app.status.operationState.phase == 'Failed'

  # --- Templates with added top-level 'summary' ---

  template.sync-succeeded: |
    teams:
      text: Application {{.app.metadata.name}} has been successfully synced at {{.app.status.operationState.finishedAt}}.
      summary: "{{.app.metadata.name}} sync succeeded"
      themeColor: "#000080"
      sections: |
        [{
          "facts": [
            {
              "name": "Sync Status",
              "value": "{{.app.status.sync.status}}"
            },
            {
              "name": "Repository",
              "value": "{{.app.spec.source.repoURL}}"
            }
          ]
        }]
      potentialAction: |-
        [{
          "@type":"OpenUri",
          "name":"Operation Details",
          "targets":[{
            "os":"default",
            "uri":"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true"
          }]
        }]
      title: Application {{.app.metadata.name}} has been successfully synced

  template.sync-failed: |
    teams:
      text: Application {{.app.metadata.name}} Sync Failed {{.app.status.operationState.finishedAt}}.
      summary: "{{.app.metadata.name}} Sync Failed"
      themeColor: "#000080"
      sections: |
        [{
          "facts": [
            {
              "name": "Sync Status",
              "value": "{{.app.status.sync.status}}"
            },
            {
              "name": "Repository",
              "value": "{{.app.spec.source.repoURL}}"
            }
          ]
        }]
      potentialAction: |-
        [{
          "@type":"OpenUri",
          "name":"Operation Details",
          "targets":[{
            "os":"default",
            "uri":"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true"
          }]
        }]
      title: Application {{.app.metadata.name}} Sync Failed

  # template.sync-failed: |
  #   teams:
  #     payload: |
  #       {
  #         "type": "message",
  #         "summary": "ArgoCD App {{.app.metadata.name}} Sync Failed", # <-- ADDED THIS LINE
  #         "attachments": [
  #           {
  #             "contentType": "application/vnd.microsoft.card.adaptive",
  #             "contentUrl": null,
  #             "content": {
  #               "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  #               "type": "AdaptiveCard",
  #               "version": "1.2",
  #               "msteams": {
  #                 "width": "full",
  #                 "summary": "ArgoCD App {{.app.metadata.name}} Sync Failed", # This summary is for the card preview
  #                 "themeColor": "E96D76"
  #               },
  #               "body": [
  #                 {
  #                   "type": "TextBlock",
  #                   "text": "❌ ArgoCD App **{{.app.metadata.name}}** Sync Failed",
  #                   "wrap": true,
  #                   "size": "Medium",
  #                   "weight": "Bolder",
  #                   "color": "Attention"
  #                 },
  #                 {
  #                   "type": "FactSet",
  #                   "facts": [
  #                     {
  #                       "title": "Sync Status:",
  #                       "value": "{{.app.status.sync.status}}"
  #                     },
  #                     {
  #                       "title": "Health Status:",
  #                       "value": "{{.app.status.health.status}}"
  #                     },
  #                     {
  #                       "title": "Namespace:",
  #                       "value": "{{.app.metadata.namespace}}"
  #                     },
  #                     {
  #                       "title": "Message:",
  #                       "value": "{{.app.status.operationState.message}}"
  #                     }
  #                   ]
  #                 },
  #                 {
  #                   "type": "ActionSet",
  #                   "actions": [
  #                     {
  #                       "type": "Action.OpenUrl",
  #                       "title": "View Application in ArgoCD",
  #                       "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
  #                     }
  #                   ]
  #                 }
  #               ],
  #               "fallbackText": "ArgoCD App {{.app.metadata.name}} Sync Failed"
  #             }
  #           }
  #         ]
  #       }