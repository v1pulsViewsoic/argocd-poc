# configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  context: |
    # Ensure this URL is accessible from where ArgoCD Notifications controller runs
    # If ArgoCD is exposed externally, use the external URL.
    # If running locally/internal, ensure this matches your access.
    argocdUrl: http://localhost:8080 
  
  # Microsoft Teams Service Configuration
  # This section defines the Teams webhook URL to send notifications to.
  # The URL is now referenced from a Kubernetes Secret.
  service.teams: |
    # Reference the Secret named 'argocd-notifications-secret' and the key 'teams-webhook-url' within it.
    url: "$argocd-notifications-secret.teams-webhook-url" 

  # --- Notification Templates (Teams Only) ---

  # Notification template when an application update starts
  template.app-update-started: |
    teams:
      # Teams messages are typically structured as Adaptive Cards for rich content.
      # The payload must adhere to the Adaptive Card schema.
      payload: |
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "contentUrl": null,
              "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.2",
                "msteams": {
                  "width": "full",
                  "summary": "Application {{.app.metadata.name}} update has started."
                },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "üöÄ Application **{{.app.metadata.name}}** Update Started",
                    "wrap": true,
                    "size": "Medium",
                    "weight": "Bolder",
                    "color": "Accent"
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "Status:",
                        "value": "In Progress"
                      },
                      {
                        "title": "Started At:",
                        "value": "{{.app.status.operationState.startedAt}}"
                      }
                    ]
                  },
                  {
                    "type": "ActionSet",
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Application",
                        "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
                      }
                    ]
                  }
                ],
                "fallbackText": "Application {{.app.metadata.name}} update has started."
              }
            }
          ]
        }

  # Notification template when an application update succeeds
  template.app-update-succeeded: |
    teams:
      payload: |
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "contentUrl": null,
              "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.2",
                "msteams": {
                  "width": "full",
                  "summary": "Application {{.app.metadata.name}} update has succeeded.",
                  "themeColor": "18be52" # Green color
                },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "‚úÖ Application **{{.app.metadata.name}}** Update Succeeded",
                    "wrap": true,
                    "size": "Medium",
                    "weight": "Bolder",
                    "color": "Good"
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "Sync Status:",
                        "value": "{{.app.status.sync.status}}"
                      },
                      {
                        "title": "Finished At:",
                        "value": "{{.app.status.operationState.finishedAt}}"
                      }
                    ]
                  },
                  {
                    "type": "ActionSet",
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Application",
                        "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
                      }
                    ]
                  }
                ],
                "fallbackText": "Application {{.app.metadata.name}} update has succeeded."
              }
            }
          ]
        }

  # Notification template when an application update fails
  template.app-update-failed: |
    teams:
      payload: |
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "contentUrl": null,
              "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.2",
                "msteams": {
                  "width": "full",
                  "summary": "Application {{.app.metadata.name}} update has failed.",
                  "themeColor": "E96D76" # Red color
                },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "‚ùå Application **{{.app.metadata.name}}** Update Failed",
                    "wrap": true,
                    "size": "Medium",
                    "weight": "Bolder",
                    "color": "Attention"
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "Sync Status:",
                        "value": "Failed"
                      },
                      {
                        "title": "Finished At:",
                        "value": "{{.app.status.operationState.finishedAt}}"
                      },
                      {
                        "title": "Error:",
                        "value": "{{.app.status.operationState.message}}"
                      }
                    ]
                  },
                  {
                    "type": "ActionSet",
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View Application",
                        "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
                      }
                    ]
                  }
                ],
                "fallbackText": "Application {{.app.metadata.name}} update has failed."
              }
            }
          ]
        }

  # --- Triggers (remain unchanged as they are notification-agnostic) ---

  # Trigger when the application update starts
  trigger.on-update-started: |
    - description: Application update has started
      send:
        - app-update-started
      when: app.status.operationState.phase in ['Running', 'InProgress']

  # Trigger when the application update succeeds
  trigger.on-update-succeeded: |
    - description: Application update has succeeded
      send:
        - app-update-succeeded
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  # Trigger when the application update fails
  trigger.on-update-failed: |
    - description: Application update has failed
      send:
        - app-update-failed
      when: app.status.operationState.phase in ['Failed', 'Error', 'Unknown']