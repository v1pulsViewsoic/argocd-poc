name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Simulate build step
      run: |
        echo "üîß Simulating build step..."
        # Uncomment the line below to simulate a build failure:
        # exit 1

  notify-slack:
    runs-on: ubuntu-latest
    needs: build-and-deploy  # Ensure this job runs after 'build-and-deploy'
    if: always()             # Ensures notification is sent even if 'build-and-deploy' fails
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # Your Slack webhook URL secret

    steps:
    - name: Send Slack Notification with Custom Content
      uses: act10ns/slack@v1
      with:
        # IMPORTANT: Removed the 'status' input to gain full control over the message.
        channel: '#tarun-test'
        # Using 'blocks' for a mix of text and button
        blocks: |
          [
            # --- Main Message Text (in a section block) ---
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": |
                  ${{ github.actor }}
                  ${{ (needs.build-and-deploy.result == 'success' && '‚úÖ') || (needs.build-and-deploy.result == 'failure' && '‚ùå') || '‚ö†Ô∏è' }} Deployment Status: *${{ needs.build-and-deploy.result }}*
                  üìù Commit: `${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}`
                  üßë‚Äçüíª Triggered by: `${{ github.actor }}`
              }
            },
            # --- Commit ID Button ---
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Commit Details",
                    "emoji": true
                  },
                  # Button style changes based on job result
                  "style": "${{ (needs.build-and-deploy.result == 'success' && 'primary') || 'danger' }}",
                  "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                }
              ]
            },
            # --- Footer Context ---
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.repository }}#${{ github.run_number }}> | ${{ github.run_started_at }}"
                }
              ]
            }
          ]