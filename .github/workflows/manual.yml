name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Simulate build step
      run: |
        echo "üîß Simulating build step..."
        # Uncomment the line below to simulate a build failure:
        # exit 1

  notify-slack:
    runs-on: ubuntu-latest
    needs: build-and-deploy  # Ensure this job runs after 'build-and-deploy'
    if: always()             # Ensures notification is sent even if 'build-and-deploy' fails
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # Your Slack webhook URL secret

    steps:
    - name: Send Slack Notification with Block Kit
      uses: act10ns/slack@v1
      with:
        status: ${{ needs.build-and-deploy.result }} # Pass job result to Slack action
        channel: '#tarun-test'
        # Define the Slack message using Block Kit JSON
        blocks: |
          [
            # --- Status Header Block ---
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "${{ (needs.build-and-deploy.result == 'success' && '‚úÖ Deployment Succeeded') || (needs.build-and-deploy.result == 'failure' && '‚ùå Deployment Failed') || '‚ö†Ô∏è Deployment Status: ${{ needs.build-and-deploy.result }}' }}"
              }
            },
            # --- Details Section ---
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Repository:*\n<https://github.com/${{ github.repository }}|${{ github.repository }}>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Triggered by:*\n`${{ github.actor }}`"
                }
              ]
            },
            # --- Visual Separator ---
            {
              "type": "divider"
            },
            # --- Commit Message / PR Title Section ---
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Commit / PR Title:*\n```\n${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}\n```"
              }
            },
            # --- Action Buttons Section ---
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Commit Details",
                    "emoji": true
                  },
                  # Button style changes based on job result
                  "style": "${{ (needs.build-and-deploy.result == 'success' && 'primary') || 'danger' }}",
                  "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                },
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Workflow Run",
                    "emoji": true
                  },
                  "url": "https://github.com/${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            },
            # --- Context / Footer Section ---
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "Workflow: ${{ github.workflow }} | Run ID: ${{ github.run_id }} | Time: ${{ github.event.pull_request.updated_at || github.event.head_commit.timestamp || 'N/A' }}"
                }
              ]
            }
          ]